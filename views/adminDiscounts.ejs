<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Discounts</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/styles.css" rel="stylesheet">
</head>
<body>
  <%- include('partials/header') %>

  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Discount Codes</h2>
      <a class="btn btn-primary" href="/admin/discounts/new">Add Discount</a>
    </div>

    <% if (errors && errors.length) { %>
      <div class="alert alert-danger"><%= errors[0] %></div>
    <% } %>
    <% if (messages && messages.length) { %>
      <div class="alert alert-success"><%= messages[0] %></div>
    <% } %>

    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Code</th>
            <th>Type</th>
            <th>Scope</th>
            <th>Discount</th>
            <th>Min Spend</th>
            <th>Usage</th>
            <th>Expiry</th>
            <th>Stackable</th>
            <th>Auto</th>
            <th>Status</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (!codes || codes.length === 0) { %>
            <tr>
              <td colspan="11" class="text-muted">No discount codes created yet.</td>
            </tr>
          <% } else { %>
            <% codes.forEach(function(code) { %>
              <tr>
                <td class="fw-semibold"><%= code.code %></td>
                <td><%= code.type %></td>
                <td><%= code.scope %></td>
                <td>
                  <% if (code.discount_type === 'percent') { %>
                    <%= Number(code.discount_value).toFixed(2) %>% 
                    <% if (code.max_discount) { %>
                      <span class="text-muted">cap $<%= Number(code.max_discount).toFixed(2) %></span>
                    <% } %>
                  <% } else { %>
                    $<%= Number(code.discount_value).toFixed(2) %>
                  <% } %>
                </td>
                <td>$<%= Number(code.min_spend || 0).toFixed(2) %></td>
                <td>
                  <%= code.total_used || 0 %>
                  <% if (code.total_usage_limit) { %>
                    / <%= code.total_usage_limit %>
                  <% } else { %>
                    / ∞
                  <% } %>
                </td>
                <td><%= code.expires_at ? new Date(code.expires_at).toLocaleString() : '—' %></td>
                <td><%= code.stackable ? 'Yes' : 'No' %></td>
                <td><%= code.auto_apply ? 'Yes' : 'No' %></td>
                <td><%= code.is_active ? 'Active' : 'Inactive' %></td>
                <td class="text-end">
                  <a class="btn btn-outline-secondary btn-sm" href="/admin/discounts/<%= code.id %>/edit">Edit</a>
                  <form action="/admin/discounts/<%= code.id %>/toggle" method="POST" class="d-inline">
                    <input type="hidden" name="is_active" value="<%= code.is_active ? 0 : 1 %>">
                    <button type="submit" class="btn btn-outline-warning btn-sm"><%= code.is_active ? 'Disable' : 'Enable' %></button>
                  </form>
                  <form action="/admin/discounts/<%= code.id %>/delete" method="POST" class="d-inline" onsubmit="return confirm('Delete this discount?');">
                    <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</body>
</html>
