<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Subscription Checkout</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@600;700&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="/styles.css" rel="stylesheet">
</head>
<body>
  <%- include('partials/header') %>

  <div class="container mt-4">
    <h2>Subscription Checkout</h2>

    <% if (errors && errors.length) { %>
      <div class="alert alert-danger"><%= errors[0] %></div>
    <% } %>
    <% if (messages && messages.length) { %>
      <div class="alert alert-success"><%= messages[0] %></div>
    <% } %>

    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card">
          <div class="card-body">
            <h5 class="mb-3">Order Summary</h5>
            <div class="d-flex justify-content-between">
              <div>Subscription</div>
              <div>$<%= Number(subscriptionPrice || 40).toFixed(2) %></div>
            </div>
            <hr>
            <div class="d-flex justify-content-between fw-semibold">
              <div>Total</div>
              <div>$<%= Number(subscriptionPrice || 40).toFixed(2) %></div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card">
          <div class="card-body">
            <h5 class="mb-3">Choose Payment Method</h5>

            <div class="d-flex flex-column gap-2">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentChoice" id="sub-wallet" value="wallet">
                <label class="form-check-label" for="sub-wallet">Digital Wallet</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentChoice" id="sub-paypal" value="paypal">
                <label class="form-check-label" for="sub-paypal">PayPal</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentChoice" id="sub-nets" value="nets" <%= netsConfigured ? '' : 'disabled' %>>
                <label class="form-check-label" for="sub-nets">
                  NETS QR <%= netsConfigured ? '' : '(Not configured)' %>
                </label>
              </div>
            </div>

            <div id="payment-choice-error" class="text-danger small mt-2 d-none"></div>

            <form action="/subscription/checkout" method="POST" id="subscriptionWalletForm" class="d-none mt-3">
              <input type="hidden" name="payWithWallet" value="1">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small">Balance: $<%= (walletBalance || 0).toFixed(2) %></div>
                <% if ((walletBalance || 0) < (subscriptionPrice || 40)) { %>
                  <a href="/wallet" class="btn btn-outline-primary btn-sm">Top up wallet</a>
                <% } %>
              </div>
              <% if ((walletBalance || 0) < (subscriptionPrice || 40)) { %>
                <div class="small text-muted mb-2">Insufficient balance for subscription.</div>
              <% } %>
              <button type="submit" class="btn btn-danger w-100" id="subscriptionWalletBtn"></button>
            </form>

            <div id="paypalSection" class="d-none mt-3">
              <div id="paypal-button-container"></div>
              <div id="paypal-error" class="text-danger small mt-2 d-none"></div>
            </div>

            <form action="/subscription/nets/create-order" method="POST" id="netsPurchaseForm" class="d-none mt-3">
              <button type="submit" class="btn btn-danger w-100" id="netsPurchaseBtn">Scan NETS QR to Pay</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.paypal.com/sdk/js?client-id=<%= process.env.PAYPAL_CLIENT_ID %>&currency=<%= process.env.PAYPAL_CURRENCY || 'SGD' %>"></script>
  <script>
    const paymentChoiceError = document.querySelector('#payment-choice-error');
    const paymentRadios = document.querySelectorAll('input[name="paymentChoice"]');
    const walletForm = document.querySelector('#subscriptionWalletForm');
    const paypalSection = document.querySelector('#paypalSection');
    const netsForm = document.querySelector('#netsPurchaseForm');
    const walletBtn = document.querySelector('#subscriptionWalletBtn');
    const netsBtn = document.querySelector('#netsPurchaseBtn');
    const errorEl = document.querySelector('#paypal-error');
    const total = Number(<%= Number(subscriptionPrice || 40).toFixed(2) %>);

    const showPaypalError = (message) => {
      if (!errorEl) return;
      errorEl.textContent = message;
      errorEl.classList.remove('d-none');
    };

    const hideAll = () => {
      walletForm?.classList.add('d-none');
      paypalSection?.classList.add('d-none');
      netsForm?.classList.add('d-none');
    };

    const onChoiceChange = () => {
      hideAll();
      if (paymentChoiceError) paymentChoiceError.classList.add('d-none');
      const selected = document.querySelector('input[name="paymentChoice"]:checked');
      if (!selected) return;
      switch (selected.value) {
        case 'wallet':
          if (walletBtn) walletBtn.textContent = `Pay $${total.toFixed(2)} with Wallet`;
          walletForm?.classList.remove('d-none');
          break;
        case 'paypal':
          paypalSection?.classList.remove('d-none');
          break;
        case 'nets':
          if (netsBtn) netsBtn.textContent = `Scan NETS QR to Pay $${total.toFixed(2)}`;
          netsForm?.classList.remove('d-none');
          break;
        default:
          break;
      }
    };

    paymentRadios.forEach((radio) => radio.addEventListener('change', onChoiceChange));
    onChoiceChange();

    paypal.Buttons({
      onClick: (data, actions) => {
        const selected = document.querySelector('input[name="paymentChoice"]:checked');
        if (!selected || selected.value !== 'paypal') {
          if (paymentChoiceError) {
            paymentChoiceError.textContent = 'Please select PayPal to continue.';
            paymentChoiceError.classList.remove('d-none');
          }
          return actions.reject();
        }
        return actions.resolve();
      },
      createOrder: () => {
        return fetch('/subscription/paypal/create-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        })
          .then(res => res.json())
          .then(data => {
            if (data && data.id) return data.id;
            throw new Error(data.message || 'Unable to create PayPal order');
          })
          .catch(err => {
            showPaypalError(err.message || 'Unable to create PayPal order');
            throw err;
          });
      },
      onApprove: (data) => {
        return fetch('/subscription/paypal/capture-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderID: data.orderID })
        })
          .then(res => res.json())
          .then(result => {
            if (result && result.redirectUrl) {
              window.location = result.redirectUrl;
              return;
            }
            throw new Error(result.message || 'Payment completed, but redirect failed.');
          })
          .catch(err => {
            showPaypalError(err.message || 'Unable to capture PayPal order');
            throw err;
          });
      },
      onError: (err) => {
        console.error('PayPal error:', err);
        showPaypalError('PayPal encountered an error. Please try again.');
      }
    }).render('#paypal-button-container');
  </script>
</body>
</html>
