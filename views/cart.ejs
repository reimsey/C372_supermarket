<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Cart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@600;700&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="/styles.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
<%- include('partials/header') %>
  <!-- Cart Content -->
  <div class="container">
    <h2 class="mt-4">Shopping Cart</h2>
    <% if (errors && errors.length) { %>
      <div class="alert alert-danger"><%= errors[0] %></div>
    <% } %>
    <% if (messages && messages.length) { %>
      <div class="alert alert-success"><%= messages[0] %></div>
    <% } %>

    <% if (cart.length === 0) { %>
      <p>Your cart is empty.</p>
    <% } else { %>
      <div class="row g-4">
        <div class="col-lg-7">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
                <th>Remove</th>
              </tr>
            </thead>
            <tbody>
              <% let total = 0; %>
              <% for (let i = 0; i < cart.length; i++) { %>
                <tr>
                    <td><%= cart[i].productName %></td>
                    <td><img src="/images/<%= cart[i].image %>" width="80" class="img-thumbnail"></td>
                    <td><%= cart[i].quantity %></td>
                    <td>$<%= (cart[i].price * cart[i].quantity).toFixed(2) %></td>
                    <td>
                      <form action="/cart/remove/<%= cart[i].productId %>" method="POST" onsubmit="return confirm('Remove this item?');" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-danger">Remove</button>
                      </form>
                    </td>
                </tr>
                <% total += cart[i].price * cart[i].quantity; %>
              <% }; %>
            </tbody>
          </table>
        </div>
        <div class="col-lg-5">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="mb-3">Order Summary</h5>
              <div class="small">
                <% cart.forEach(function(item) { %>
                  <div class="d-flex justify-content-between">
                    <div><%= item.productName %> x<%= item.quantity %></div>
                    <div>$<%= (item.price * item.quantity).toFixed(2) %></div>
                  </div>
                <% }) %>
              </div>
              <hr>
              <div class="d-flex justify-content-between">
                <div>Subtotal</div>
                <div>$<%= total.toFixed(2) %></div>
              </div>
              <div class="d-flex justify-content-between text-muted">
                <div>Discounts</div>
                <div>-$<%= (discountSummary?.totalDiscount || 0).toFixed(2) %></div>
              </div>
              <div class="d-flex justify-content-between fw-semibold mt-2">
                <div>Total</div>
                <div>$<span id="cartTotal" data-total="<%= (discountSummary?.finalTotal || total).toFixed(2) %>"><%= (discountSummary?.finalTotal || total).toFixed(2) %></span></div>
              </div>
              <% if ((discountSummary?.applied || []).length > 0 || discountSummary?.autoApplied) { %>
                <div class="small text-muted mt-2">
                  <% (discountSummary.applied || []).forEach(function(item) { %>
                    <div><%= item.code %>: -$<%= Number(item.amount).toFixed(2) %></div>
                  <% }) %>
                  <% if (discountSummary.autoApplied) { %>
                    <div>Auto-applied: <%= discountSummary.autoApplied.code %></div>
                  <% } %>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Payment Options</h5>
          </div>

          <div class="border rounded p-3 mb-3">
            <div class="fw-semibold mb-2">Vouchers & Coupons</div>
            <form action="/cart/discounts/apply" method="POST" class="d-flex gap-2">
              <input type="text" name="code" class="form-control" placeholder="Enter code">
              <button type="submit" class="btn btn-outline-primary">Apply</button>
            </form>
            <% if ((discountSummary?.applied || []).length > 0 || discountSummary?.autoApplied) { %>
              <div class="mt-2 small">
                <% (discountSummary.applied || []).forEach(function(item) { %>
                  <div class="d-flex align-items-center justify-content-between">
                    <div><strong><%= item.code %></strong> -$<%= Number(item.amount).toFixed(2) %></div>
                    <form action="/cart/discounts/remove" method="POST" class="ms-2">
                      <input type="hidden" name="code" value="<%= item.code %>">
                      <button type="submit" class="btn btn-link btn-sm">Remove</button>
                    </form>
                  </div>
                <% }) %>
                <% if (discountSummary.autoApplied) { %>
                  <div class="text-muted">Auto-applied: <strong><%= discountSummary.autoApplied.code %></strong> -$<%= Number(discountSummary.autoApplied.amount).toFixed(2) %></div>
                <% } %>
              </div>
            <% } else { %>
              <div class="text-muted small mt-2">No discount applied.</div>
            <% } %>
          </div>

          <div class="border rounded p-3 mb-3">
            <div class="fw-semibold mb-2">Choose Payment Method</div>
            <div class="d-flex flex-column gap-2">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentChoice" id="pay-wallet" value="wallet">
                <label class="form-check-label" for="pay-wallet">Digital Wallet</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentChoice" id="pay-card" value="card">
                <label class="form-check-label" for="pay-card">Manual Card</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentChoice" id="pay-paypal" value="paypal">
                <label class="form-check-label" for="pay-paypal">PayPal</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentChoice" id="pay-nets" value="nets">
                <label class="form-check-label" for="pay-nets">NETS QR</label>
              </div>
            </div>
          </div>

          <div id="payment-choice-error" class="text-danger small mb-2 d-none"></div>

          <form action="/purchase" method="POST" id="walletPurchaseForm" class="d-none">
            <input type="hidden" name="payWithWallet" value="1">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="text-muted small">Balance: $<%= (walletBalance || 0).toFixed(2) %></div>
              <% if ((walletBalance || 0) < (discountSummary?.finalTotal || cartSubtotal || 0)) { %>
                <a href="/wallet" class="btn btn-outline-primary btn-sm">Top up wallet</a>
              <% } %>
            </div>
            <% if ((walletBalance || 0) < (discountSummary?.finalTotal || cartSubtotal || 0)) { %>
              <div class="small text-muted mb-2">Insufficient balance for this cart total.</div>
            <% } %>
            <button type="submit" class="btn btn-danger w-100" id="walletPurchaseBtn"></button>
          </form>

          <form action="/purchase" method="POST" id="cardPurchaseForm" class="d-none">
            <input type="hidden" name="paymentMethodLabel" id="cardPaymentLabel" value="Card">
            <div class="row g-2">
              <div class="col-md-6">
                <input type="text" name="cardName" class="form-control" placeholder="Name on card" required>
              </div>
              <div class="col-md-6">
                <input type="text" name="cardNumber" class="form-control" placeholder="Card number" required>
              </div>
              <div class="col-md-6">
                <input type="text" name="cardExpiry" class="form-control" placeholder="MM/YY" required>
              </div>
              <div class="col-md-6">
                <input type="text" name="cardCvv" class="form-control" placeholder="CVV" required>
              </div>
            </div>
            <button type="submit" class="btn btn-danger w-100 mt-3" id="cardPurchaseBtn">Pay with Card</button>
          </form>

          <div id="paypalSection" class="d-none">
            <div id="paypal-button-container"></div>
            <div id="paypal-error" class="text-danger small mt-2 d-none"></div>
          </div>

          <form action="/nets/create-order" method="POST" id="netsPurchaseForm" class="d-none">
            <input type="hidden" name="cartTotal" value="<%= total.toFixed(2) %>">
            <button type="submit" class="btn btn-danger w-100" id="netsPurchaseBtn">Scan NETS QR to Pay</button>
          </form>
        </div>
      </div>

      <div class="mt-4">
        <a href="/shopping" class="btn btn-secondary">Back to Shopping</a>
      </div>
      
    <% } %>
  </div>

  <% if (cart.length > 0) { %>
    <script src="https://www.paypal.com/sdk/js?client-id=<%= process.env.PAYPAL_CLIENT_ID %>&currency=<%= process.env.PAYPAL_CURRENCY || 'SGD' %>"></script>
    <script>
      const cartItems = <%- JSON.stringify(cart.map(item => ({
        productId: item.productId,
        quantity: item.quantity
      }))) %>;
      const totalEl = document.querySelector('#cartTotal');
      const cartTotal = Number(totalEl?.dataset?.total || totalEl?.textContent || 0);
      const errorEl = document.querySelector('#paypal-error');

      const showPaypalError = (message) => {
        if (!errorEl) return;
        errorEl.textContent = message;
        errorEl.classList.remove('d-none');
      };

      const paymentChoiceError = document.querySelector('#payment-choice-error');
      const paymentRadios = document.querySelectorAll('input[name="paymentChoice"]');
      const walletForm = document.querySelector('#walletPurchaseForm');
      const cardForm = document.querySelector('#cardPurchaseForm');
      const paypalSection = document.querySelector('#paypalSection');
      const netsForm = document.querySelector('#netsPurchaseForm');
      const walletBtn = document.querySelector('#walletPurchaseBtn');
      const cardBtn = document.querySelector('#cardPurchaseBtn');
      const netsBtn = document.querySelector('#netsPurchaseBtn');
      const cardPaymentLabel = document.querySelector('#cardPaymentLabel');

      const walletBalance = Number(<%= (walletBalance || 0).toFixed(2) %>);
      const cartTotalValue = Number(totalEl?.dataset?.total || totalEl?.textContent || 0);
      const walletLabel = `Pay $${cartTotalValue.toFixed(2)} with Wallet (Balance: $${walletBalance.toFixed(2)})`;

      const hideAll = () => {
        walletForm?.classList.add('d-none');
        cardForm?.classList.add('d-none');
        paypalSection?.classList.add('d-none');
        netsForm?.classList.add('d-none');
      };

      const updateWalletButton = () => {
        if (!walletBtn) return;
        walletBtn.textContent = walletLabel;
        const disabled = walletBalance < cartTotalValue;
        walletBtn.disabled = disabled;
      };

      const updateCardButton = () => {
        if (!cardBtn) return;
        cardBtn.textContent = `Pay $${cartTotalValue.toFixed(2)} with Card`;
      };

      const updateNetsButton = () => {
        if (!netsBtn) return;
        netsBtn.textContent = `Scan NETS QR to Pay $${cartTotalValue.toFixed(2)}`;
      };

      const updateCardLabel = () => {
        if (!cardPaymentLabel) return;
        const numberField = cardForm?.querySelector('input[name="cardNumber"]');
        const digits = String(numberField?.value || '').replace(/\D/g, '');
        const last4 = digits.slice(-4);
        cardPaymentLabel.value = last4 ? `Card **** ${last4}` : 'Card';
      };

      const onChoiceChange = () => {
        hideAll();
        if (paymentChoiceError) paymentChoiceError.classList.add('d-none');
        const selected = document.querySelector('input[name="paymentChoice"]:checked');
        if (!selected) return;
        switch (selected.value) {
          case 'wallet':
            updateWalletButton();
            walletForm?.classList.remove('d-none');
            break;
          case 'card':
            updateCardButton();
            cardForm?.classList.remove('d-none');
            break;
          case 'paypal':
            paypalSection?.classList.remove('d-none');
            break;
          case 'nets':
            updateNetsButton();
            netsForm?.classList.remove('d-none');
            break;
          default:
            break;
        }
      };

      paymentRadios.forEach((radio) => radio.addEventListener('change', onChoiceChange));
      onChoiceChange();

      if (cardForm) {
        cardForm.addEventListener('input', updateCardLabel);
        updateCardLabel();
      }

      paypal.Buttons({
        onClick: (data, actions) => {
          if (!cartItems.length) {
            showPaypalError('Your cart is empty.');
            return actions.reject();
          }
          const selected = document.querySelector('input[name="paymentChoice"]:checked');
          if (!selected || selected.value !== 'paypal') {
            if (paymentChoiceError) {
              paymentChoiceError.textContent = 'Please select PayPal to continue.';
              paymentChoiceError.classList.remove('d-none');
            }
            return actions.reject();
          }
          return actions.resolve();
        },
        createOrder: () => {
          return fetch('/paypal/create-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              cartItemIds: cartItems.map(item => item.productId),
              total: cartTotal
            })
          })
            .then(res => res.json())
            .then(data => {
              if (data && data.id) return data.id;
              throw new Error(data.message || 'Unable to create PayPal order');
            })
            .catch(err => {
              showPaypalError(err.message || 'Unable to create PayPal order');
              throw err;
            });
        },
        onApprove: (data) => {
          return fetch('/paypal/capture-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              orderID: data.orderID,
              cartItemIds: cartItems.map(item => item.productId)
            })
          })
            .then(res => res.json())
            .then(result => {
              if (result && result.receiptUrl) {
                window.location = result.receiptUrl;
                return;
              }
              throw new Error(result.message || 'Payment completed, but redirect failed.');
            })
            .catch(err => {
              showPaypalError(err.message || 'Unable to capture PayPal order');
              throw err;
            });
        },
        onError: (err) => {
          console.error('PayPal error:', err);
          showPaypalError('PayPal encountered an error. Please try again.');
        }
      }).render('#paypal-button-container');
    </script>
  <% } %>
</body>
</html>
