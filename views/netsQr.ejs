<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= title %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/styles.css" rel="stylesheet">
</head>
<body>
  <%- include('partials/header') %>
  <div class="container py-4">
    <h2 class="mb-2">Scan the NETS QR Code</h2>
    <p class="text-muted">Scan with your bank simulator app to complete payment.</p>

    <div class="row g-4 align-items-center">
      <div class="col-md-6">
        <div class="border rounded p-3 bg-white">
          <img src="<%= qrCodeUrl %>" alt="NETS QR Code" class="img-fluid">
        </div>
        <p id="timer" class="mt-2 fw-semibold">Time remaining: 5:00</p>
        <div class="d-flex align-items-center gap-2">
          <img src="/images/progressSpinner.gif" alt="Loading" width="24" height="24">
          <span id="status">Waiting for payment...</span>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="mb-3">Order Summary</h5>
            <% if (cartItems && cartItems.length > 0) { %>
              <div class="small">
                <% cartItems.forEach(function(item) { %>
                  <div class="d-flex justify-content-between">
                    <div><%= item.productName %> x<%= item.quantity %></div>
                    <div>$<%= (item.price * item.quantity).toFixed(2) %></div>
                  </div>
                <% }) %>
              </div>
              <hr>
              <div class="d-flex justify-content-between">
                <div>Subtotal</div>
                <div>$<%= Number(discountSummary?.subtotal || total).toFixed(2) %></div>
              </div>
              <div class="d-flex justify-content-between text-muted">
                <div>Vouchers</div>
                <div>-$<%= Number(discountSummary?.totalDiscount || 0).toFixed(2) %></div>
              </div>
              <div class="d-flex justify-content-between text-muted">
                <div>Delivery</div>
                <div>$<%= Number(pricing?.deliveryFee || 0).toFixed(2) %></div>
              </div>
              <div class="d-flex justify-content-between fw-semibold mt-2">
                <div>Total</div>
                <div>$<%= Number(pricing?.finalTotal || discountSummary?.finalTotal || total).toFixed(2) %></div>
              </div>
              <% if ((discountSummary?.applied || []).length > 0 || discountSummary?.autoApplied) { %>
                <div class="small text-muted mt-2">
                  <% (discountSummary.applied || []).forEach(function(item) { %>
                    <div><%= item.code %>: -$<%= Number(item.amount).toFixed(2) %></div>
                  <% }) %>
                  <% if (discountSummary.autoApplied) { %>
                    <div>Auto-applied: <%= discountSummary.autoApplied.code %></div>
                  <% } %>
                </div>
              <% } %>
            <% } else if (topupAmount) { %>
              <div class="d-flex justify-content-between">
                <div>Top-up Amount</div>
                <div>$<%= Number(topupAmount).toFixed(2) %></div>
              </div>
            <% } else { %>
              <div class="text-muted">Summary unavailable.</div>
            <% } %>
          </div>
        </div>

        <img src="/images/netsQrInfo.png" class="img-fluid mb-3" alt="NETS QR Info">
        <div class="d-flex gap-2">
          <a href="/cart" class="btn btn-outline-secondary">Back to Cart</a>
          <a href="/shopping" class="btn btn-secondary">Continue Shopping</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    let sse;
    const txnRetrievalRef = "<%= txnRetrievalRef %>";
    const fallbackUrl = `/nets/sse/payment-status/${txnRetrievalRef}`;
    const url = "<%= typeof sseUrl !== 'undefined' && sseUrl ? sseUrl : '' %>" || fallbackUrl;
    const successUrl = "<%= typeof successUrl !== 'undefined' && successUrl ? successUrl : '' %>";
    const failUrl = "<%= typeof failUrl !== 'undefined' && failUrl ? failUrl : '' %>";

    if (sse) {
      sse.close();
    }

    sse = new EventSource(url);
    sse.addEventListener("message", (event) => {
      const data = JSON.parse(event.data);
      if (data && data.success) {
        sse.close();
        const nextUrl = data.receiptUrl || data.redirectUrl || successUrl || "/nets-qr/success";
        window.location.href = nextUrl;
      } else if (data && data.fail) {
        sse.close();
        const nextUrl = data.redirectUrl || failUrl || "/nets-qr/fail";
        window.location.href = nextUrl;
      }
    });

    const timerElement = document.getElementById("timer");
    const statusElement = document.getElementById("status");
    const countdownDuration = 300;
    let remainingTime = countdownDuration;

    const updateTimer = () => {
      const minutes = Math.floor(remainingTime / 60);
      const seconds = remainingTime % 60;
      timerElement.textContent = `Time remaining: ${minutes}:${seconds.toString().padStart(2, "0")}`;
      remainingTime -= 1;

      if (remainingTime < 0) {
        clearInterval(timerInterval);
        timerElement.textContent = "Transaction timed out.";
        if (statusElement) statusElement.textContent = "Timeout. Redirecting...";
        if (sse) sse.close();
        window.location.href = "/nets-qr/fail";
      }
    };

    const timerInterval = setInterval(updateTimer, 1000);
    updateTimer();
  </script>
</body>
</html>
