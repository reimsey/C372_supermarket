<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wallet</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@600;700&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="/styles.css" rel="stylesheet">
</head>
<body>
  <%- include('partials/header') %>

  <div class="container mt-4">
    <h2>Wallet</h2>

    <% if (errors && errors.length) { %>
      <div class="alert alert-danger"><%= errors[0] %></div>
    <% } %>
    <% if (messages && messages.length) { %>
      <div class="alert alert-success"><%= messages[0] %></div>
    <% } %>

    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-bold">Current Balance</div>
          <div class="fs-4">$<%= (balance || 0).toFixed(2) %></div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="mb-3">Top-up Wallet</h5>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label" for="walletTopupAmount">Amount</label>
            <input id="walletTopupAmount" type="number" step="0.01" min="0.01" class="form-control" required>
          </div>
          <div class="col-12">
            <label class="form-label">Choose Payment Method</label>
            <div class="d-flex flex-column gap-2">
              <% if (paymentMethods && paymentMethods.length > 0) { %>
                <% paymentMethods.forEach(function(pm, idx) { %>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="walletPaymentChoice" id="wallet-pm-<%= pm.id %>" value="saved:<%= pm.id %>" data-label="<%= pm.methodName %> <%= pm.cardNumber || pm.maskedDetails %>" <%= idx === 0 ? 'checked' : '' %>>
                    <label class="form-check-label" for="wallet-pm-<%= pm.id %>">
                      <%= pm.methodName %> <span class="text-muted"><%= pm.cardNumber || pm.maskedDetails %></span> (Exp: <%= pm.expireDate %>)
                    </label>
                  </div>
                <% }); %>
              <% } else { %>
                <div class="text-muted">No saved payment methods yet.</div>
              <% } %>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="walletPaymentChoice" id="wallet-paypal" value="paypal">
                <label class="form-check-label" for="wallet-paypal">PayPal</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="walletPaymentChoice" id="wallet-nets" value="nets">
                <label class="form-check-label" for="wallet-nets">NETS QR</label>
              </div>
            </div>
          </div>
          <div class="col-12">
            <form id="walletSavedForm" action="/wallet/topup" method="POST" class="d-none">
              <input type="hidden" name="amount" id="walletSavedAmount">
              <input type="hidden" name="paymentMethodLabel" id="walletSavedLabel">
            </form>
            <form id="walletNetsForm" action="/wallet/nets/create-order" method="POST" class="d-none">
              <input type="hidden" name="amount" id="walletNetsAmount">
            </form>
            <div id="walletSavedActions" class="d-none">
              <button type="submit" form="walletSavedForm" class="btn btn-primary">Top Up</button>
            </div>
            <div id="walletPaypalActions" class="d-none">
              <div id="wallet-paypal-button-container"></div>
              <div id="wallet-paypal-error" class="text-danger small mt-2 d-none"></div>
            </div>
            <div id="walletNetsActions" class="d-none">
              <button type="submit" form="walletNetsForm" class="btn btn-success">Generate NETS QR</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <h5>Wallet Ledger</h5>
    <% if (!ledger || ledger.length === 0) { %>
      <p class="text-muted">No wallet activity yet.</p>
    <% } else { %>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Amount</th>
              <th>Balance After</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody>
            <% ledger.forEach(function(entry) { %>
              <tr>
                <td><%= entry.createdAt?.toLocaleString ? entry.createdAt.toLocaleString() : entry.createdAt %></td>
                <td><%= entry.type %></td>
                <td>$<%= Number(entry.amount).toFixed(2) %></td>
                <td>$<%= Number(entry.balance_after).toFixed(2) %></td>
                <td><%= entry.note || '' %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
  </div>

  <script src="https://www.paypal.com/sdk/js?client-id=<%= process.env.PAYPAL_CLIENT_ID %>&currency=<%= process.env.PAYPAL_CURRENCY || 'SGD' %>"></script>
  <script>
    const amountInput = document.getElementById('walletTopupAmount');
    const choiceInputs = document.querySelectorAll('input[name="walletPaymentChoice"]');
    const savedActions = document.getElementById('walletSavedActions');
    const paypalActions = document.getElementById('walletPaypalActions');
    const netsActions = document.getElementById('walletNetsActions');
    const savedAmount = document.getElementById('walletSavedAmount');
    const savedLabel = document.getElementById('walletSavedLabel');
    const netsAmount = document.getElementById('walletNetsAmount');
    const paypalError = document.getElementById('wallet-paypal-error');

    const getSelectedChoice = () => {
      const selected = document.querySelector('input[name="walletPaymentChoice"]:checked');
      return selected ? selected.value : '';
    };

    const setAmounts = () => {
      const value = amountInput.value;
      savedAmount.value = value;
      netsAmount.value = value;
      const selected = document.querySelector('input[name="walletPaymentChoice"]:checked');
      savedLabel.value = selected?.dataset?.label || 'Saved payment method';
    };

    const toggleActions = () => {
      const choice = getSelectedChoice();
      savedActions.classList.toggle('d-none', !choice.startsWith('saved:'));
      paypalActions.classList.toggle('d-none', choice !== 'paypal');
      netsActions.classList.toggle('d-none', choice !== 'nets');
    };

    amountInput.addEventListener('input', setAmounts);
    choiceInputs.forEach((input) => {
      input.addEventListener('change', () => {
        setAmounts();
        toggleActions();
      });
    });

    if (!document.querySelector('input[name="walletPaymentChoice"]:checked')) {
      const paypalRadio = document.getElementById('wallet-paypal');
      if (paypalRadio) paypalRadio.checked = true;
    }
    setAmounts();
    toggleActions();

    const showPaypalError = (message) => {
      if (!paypalError) return;
      paypalError.textContent = message;
      paypalError.classList.remove('d-none');
    };

    paypal.Buttons({
      onClick: (data, actions) => {
        const amount = Number(amountInput.value || 0);
        if (!amount || amount <= 0) {
          showPaypalError('Enter a valid top-up amount.');
          return actions.reject();
        }
        return actions.resolve();
      },
      createOrder: () => {
        const amount = Number(amountInput.value || 0);
        return fetch('/wallet/paypal/create-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount })
        })
          .then(res => res.json())
          .then(data => {
            if (data && data.id) return data.id;
            throw new Error(data.message || 'Unable to create PayPal order');
          })
          .catch(err => {
            showPaypalError(err.message || 'Unable to create PayPal order');
            throw err;
          });
      },
      onApprove: (data) => {
        return fetch('/wallet/paypal/capture-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderID: data.orderID })
        })
          .then(res => res.json())
          .then(result => {
            if (result && result.redirectUrl) {
              window.location = result.redirectUrl;
              return;
            }
            throw new Error(result.message || 'Payment completed, but redirect failed.');
          })
          .catch(err => {
            showPaypalError(err.message || 'Unable to capture PayPal order');
            throw err;
          });
      },
      onError: (err) => {
        console.error('PayPal error:', err);
        showPaypalError('PayPal encountered an error. Please try again.');
      }
    }).render('#wallet-paypal-button-container');
  </script>
</body>
</html>
